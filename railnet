-- Railnet manager
-- by Tastyfish

os.loadAPI "/extlib/dev"
os.loadAPI "/extlib/gui"
os.loadAPI "/extlib/db"

local railDB = db.openOrCreate("/railnet.db", {name="string", dest="string", description="string", usage="number"})
local screen = dev.get("monitor")
local printer = dev.get("ticketmachine")

local screenW, screenH
function setScale(scale)
	screen.setTextScale(scale)
	screenW, screenH = screen.getSize()
	screenW = math.floor(screenW / 2) * 2
	screenH = math.floor(screenH / 2) * 2
end
setScale(1.5)
local page = 1
local pageSize = screenH - 6
local printTimer, countdownTimer
local ticketDest, countdown

local function getDestinations(page)
	return railDB:query():sortByDescending("usage"):skip((page - 1) * pageSize):take(pageSize)
end

---- Forms ---
local downScreen, destScreen, printScreen, countdownScreen

---- Down Screen ----
gui.newLabel{
	text = "Out of Order",
	color = colors.yellow,
	bounds = rect.new(1, 1, screenW, screenH)
}
downScreen = gui.finishForm()

---- Destination Selection Screen ----
gui.newLabel{
	text = "ICing Station List",
	color = colors.cyan,
	bounds = rect.new(1, 1, screenW, 1)
}
local destList
destList = gui.newListBox{
	bounds = rect.new(1, 3, screenW, pageSize),
	select = function()
		ticketDest = destList.items[destList.selectedItem]
		gui.setForm(screen, printScreen)
	end,
}
local pageNumber = gui.newLabel{
	text = "x",
	bounds = rect.new(screenW / 2 - 1, screenH, 4, 1),
	color = colors.yellow
}
local function updateList()
	pageNumber.text = tostring(page)
	pageNumber:draw(screen)
	destList.items = getDestinations(page):select("name"):values()
	--function(e)
		--if e.description and #e.description > 0 then
		--	return ("%20s: %s"):format(tostring(e.name), tostring(e.description))
		--else
		--	return ("%20s"):format(tostring(e.name))
		--end
		--return e.name
	--end)
	destList:draw(screen)
end
gui.newButton{
	text = "< Prev",
	bounds = rect.new(2, screenH, screenW / 2 - 3, 1),
	click = function()
		if page <= 1 then
			return
		end
		page = page - 1
		updateList()
	end
}
gui.newButton{
	text = "Next >",
	bounds = rect.new(screenW / 2 + 3, screenH, screenW / 2 - 3, 1),
	click = function()
		page = page + 1
		updateList()
	end
}
destScreen = gui.finishForm(function()
	page = 1
	updateList()
	if #destList.items == 0 then
		gui.setForm(screen, downScreen)
	end
end)

---- Printing Screen ----
gui.newLabel {
  text = "Printing Ticket",
  color = colors.cyan,
  bounds = rect.new(1, 1, screenW, 1)
}
local printStatusLabel = gui.newLabel {
  text = "",
  color = colors.yellow,
  bounds = rect.new(1, 3, screenW, 1)
}
gui.newButton {
  text = "Cancel",
  color = colors.red,
  highlight = colors.yellow,
  bounds = rect.new(1, 5, screenW, 3),
  click = function()
    gui.setForm(screen, destScreen)
    printTimer = nil
  end
}
function updatePrint()
	-- check paper and ink
	local paper, ink
	if printer.getStackInSlot(1) then
		paper = printer.getStackInSlot(1).qty
	else
		paper = 0
	end
	if printer.getStackInSlot(2) then
		ink = printer.getStackInSlot(2).qty
	else
		ink = 0
	end
	
	if paper == 0 then
		printStatusLabel.text = "TICKET ROLL EMPTY"
	elseif ink == 0 then
		printStatusLabel.text = "INK DRY"
	else
		printStatusLabel.text = "Blanks: "..paper..
			" Ink: "..(ink*100/64).."%"
	end
	gui.draw(screen)
	
	if paper > 0 and ink > 0 then
		printer.createTicket(ticketDest)
		gui.setForm(screen, countdownScreen)
	else
		printTimer = os.startTimer(1)
	end
end
printScreen = gui.finishForm(function()
	updatePrint()
end)

---- Countdown Screen ----
gui.newLabel {
  text = "Departing in",
  color = colors.white,
  bounds = rect.new(1, screenH / 2, screenW, 1)
}
local countdownLabel = gui.newLabel {
  text = "x",
  color = colors.yellow,
  bounds = rect.new(1, screenH / 2 + 1, screenW, 1)
}
function updateCountdown()
	if countdown == 1 then
		setScale(1.5)
		gui.setForm(screen, destScreen)
	else
		countdownLabel.text = tostring(countdown).." sec"
		countdownLabel:draw(screen)
		
		countdownTimer = os.createTimer(1)
		countdown = countdown - 1
	end
end
countdownScreen = gui.finishForm(function()
	countdown = 5
	setScale(2)
	
	updateCountdown()
end)

local function addDest()
	io.write "Name? "
	local name = io.read()
	local dest = name:gsub("%W+", "")
	io.write "Description? "
	local desc = io.read()
	io.write("Dest ("..dest..")? ")
	local destt = io.read()
	if destt ~= "" then
		dest = destt
	end
	
	-- check for collision
	local match = railDB:query():where("$name:upper() == ?:upper() or $dest:upper() == ?:upper()", name, dest):selectFirst()
	if match then
		print(("Collides with station %s."):format(match.name))
	else
		railDB:insert{name = name, description = desc, dest = dest, usage = 0}
	end
	updateList()
end

local function deleteDest()
	io.write "Name? "
	local name = io.read()
	local match = railDB:query():where("$name:upper() == ?:upper()", name):selectFirst()
	if not match then
		print("Could not find entry.")
	else
		railDB:query():where("$name == ?", name):delete()
	end
end

local function editDest()
	io.write "Old name?"
	local name = io.read()
	local match = railDB:query():where("$name:upper() == ?:upper()", name):selectFirst()
	
	io.write "New name? "
	name = io.read()
	if not match then
		print("Could not find entry.")
		return
	else
	
	io.write "Name("..match.name..")? "
	local name = io.read()
	if #name == 0 then name = match.name end
	
	io.write "Description("..match.description..")? "
	local desc = io.read()
	if #desc == 0 then desc = match.description end
	
	io.write("Dest ("..match.dest..")? ")
	local dest = io.read()
	if #dest == 0 then dest = match.dest end
	
	railDB:query():where("$name==?", match.name):update{name = name, description = desc, dest = dest}
	updateList()
end

---- main program loop ----
gui.setForm(screen, destScreen)
while true do
	local event, p1, p2, p3, p4 = os.pullEvent()
	if event == "mouse_click" or event == "monitor_touch" then
		gui.click(screen, p2, p3)
	elseif event == "mouse_drag" then
		gui.drag(screen, p2, p3)
	elseif event == "char" then
		--gui.keypress(screen, p1, true)
		if p1 == "a" then
			addDest()
		elseif p1 == "d" then
			deleteDest()
		elseif p1 == "e" then
			editDest()
		elseif p1 == "q" then
			gui.setForm(screen, downScreen)
			break
		end
	elseif event == "key" then
		--gui.keypress(screen, p1, false)
	elseif event == "timer" then
		if p1 == printTimer then
			updatePrint()
		elseif p1 == countdownTimer then
			updateCountdown()
		end
	end
end
